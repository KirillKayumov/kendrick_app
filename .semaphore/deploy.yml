version: v1.0
name: Kendrick Deploy Pipeline
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Deploy to Heroku
    task:
      prologue:
        commands:
          - checkout
          - git remote add heroku https://git.heroku.com/kendrick-app.git
          - git config heroku.remote heroku
      jobs:
        - name: Deploy
          commands:
            - heroku maintenance:on
            - git push --force heroku $BRANCH_NAME:master
            - heroku run "POOL_SIZE=2 mix ecto.migrate"
            - heroku restart
            - heroku maintenance:off
